<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinuxÁÆÄÂçïÁõëÊéß</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <style>
        [v-cloak] {
            display: none;
        }

        body {
            background-color: #0f172a;
            color: #e2e8f0;
        }

        /* Tailwind slate-900 / slate-200 */
    </style>
</head>

<body class="antialiased font-sans flex items-center justify-center min-h-screen">

    <div id="app" v-cloak class="w-full h-full min-h-screen flex items-center justify-center">

        <!-- Login Modal -->
        <div v-if="!isAuthenticated"
            class="w-full max-w-md bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700">
            <h2 class="text-3xl font-bold mb-6 text-center text-white">LinuxÁÆÄÂçïÁõëÊéß</h2>
            <form @submit.prevent="login" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-300">Ë¥¶Âè∑</label>
                    <input type="text" v-model="loginForm.username" required
                        class="mt-1 block w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300">ÂØÜÁ†Å</label>
                    <input type="password" v-model="loginForm.password" required
                        class="mt-1 block w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition">
                </div>
                <div v-if="loginError" class="text-red-400 text-sm mt-2">{{ loginError }}</div>
                <button type="submit"
                    class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-medium shadow-lg hover:shadow-indigo-500/30 transition duration-200">
                    ÂÆâÂÖ®ÁôªÂΩï
                </button>
            </form>
        </div>

        <!-- Main Dashboard -->
        <div v-else class="w-full min-h-screen bg-slate-900 flex flex-col">
            <!-- Top Nav -->
            <nav class="bg-slate-800 border-b border-slate-700 px-6 py-4 flex justify-between items-center shadow-md">
                <h1 class="text-xl font-bold text-white flex items-center gap-2">
                    <svg class="w-6 h-6 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01">
                        </path>
                    </svg>
                    LinuxÁÆÄÂçïÁõëÊéß
                </h1>
                <div class="flex flex-wrap items-center gap-3">
                    <div class="flex items-center gap-2">
                        <select v-model="timeRange" @change="fetchMetricsHistory"
                            class="bg-slate-900 border border-slate-700 text-sm rounded focus:ring-indigo-500 focus:border-indigo-500 block p-2 text-white">
                            <option value="15">ËøáÂéª 15 ÂàÜÈíü</option>
                            <option value="60">ËøáÂéª 1 Â∞èÊó∂</option>
                            <option value="360">ËøáÂéª 6 Â∞èÊó∂</option>
                            <option value="1440">ËøáÂéª 24 Â∞èÊó∂</option>
                            <option value="custom">üìÖ Ëá™ÂÆö‰πâÊó∂Èó¥ÊÆµ</option>
                        </select>
                        <div v-if="timeRange === 'custom'" class="flex items-center gap-2">
                            <input type="datetime-local" v-model="customTime.start" style="color-scheme: dark;"
                                class="bg-slate-900 border border-slate-700 text-sm rounded p-1.5 text-white focus:outline-none focus:border-indigo-500">
                            <span class="text-slate-500">-</span>
                            <input type="datetime-local" v-model="customTime.end" style="color-scheme: dark;"
                                class="bg-slate-900 border border-slate-700 text-sm rounded p-1.5 text-white focus:outline-none focus:border-indigo-500">
                            <button @click="fetchMetricsHistory"
                                class="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 rounded text-sm text-white transition">Êü•ËØ¢</button>
                        </div>
                        <button @click="clearHistory"
                            class="px-3 py-2 bg-rose-900/40 hover:bg-rose-900/80 text-rose-300 rounded text-sm transition"
                            title="Âº∫Âà∂Ê∏ÖÁ©∫ SQLite ‰∏≠ÁöÑÂéÜÂè≤ÊåáÊ†áËÆ∞ÂΩï">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                </path>
                            </svg>
                        </button>
                    </div>
                    <button @click="toggleEditLayout"
                        :class="isEditingLayout ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-slate-700 hover:bg-slate-600'"
                        class="px-4 py-2 rounded text-sm text-white transition flex items-center gap-1 shadow">
                        <svg class="w-4 h-4" v-if="!isEditingLayout" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                        <svg class="w-4 h-4" v-else fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7">
                            </path>
                        </svg>
                        {{ isEditingLayout ? '‰øùÂ≠òÂ∏ÉÂ±Ä' : 'ÁºñËæëÂ∏ÉÂ±Ä' }}
                    </button>
                    <button @click="openPwdModal"
                        class="px-4 py-2 bg-indigo-700 hover:bg-indigo-600 rounded text-sm text-white transition shadow">
                        ‰øÆÊîπÂØÜÁ†Å
                    </button>
                    <button @click="logout"
                        class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm text-white transition">
                        ÂÆâÂÖ®ÈÄÄÂá∫
                    </button>
                </div>
            </nav>

            <!-- Content -->
            <div id="dashboard-grid" class="p-6 flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6">

                <!-- CPU Chart -->
                <div id="module-cpu" class="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
                    <div class="flex justify-between items-center mb-2 drag-handle"
                        :class="{'cursor-move bg-slate-700/50 rounded p-1': isEditingLayout}">
                        <h3 class="text-slate-300 font-medium">Ê†∏ÂøÉÂ§ÑÁêÜÂô®‰ΩøÁî®Áéá (CPU %)</h3>
                        <button @click="collapsed.cpu = !collapsed.cpu"
                            class="text-slate-500 hover:text-white transition">
                            <svg class="w-4 h-4 transform transition-transform" :class="{ 'rotate-180': collapsed.cpu }"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                    </div>
                    <div v-show="!collapsed.cpu" id="cpuChart" class="w-full h-64"></div>
                </div>

                <!-- Memory Chart -->
                <div id="module-mem" class="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
                    <div class="flex justify-between items-center mb-2 drag-handle"
                        :class="{'cursor-move bg-slate-700/50 rounded p-1': isEditingLayout}">
                        <h3 class="text-slate-300 font-medium">Áâ©ÁêÜÂÜÖÂ≠òÊ∂àËÄó (RAM MB)</h3>
                        <button @click="collapsed.mem = !collapsed.mem"
                            class="text-slate-500 hover:text-white transition">
                            <svg class="w-4 h-4 transform transition-transform" :class="{ 'rotate-180': collapsed.mem }"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                    </div>
                    <div v-show="!collapsed.mem" id="memChart" class="w-full h-64"></div>
                </div>

                <!-- Disk Usage (New) -->
                <div id="module-disk"
                    class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg flex flex-col justify-center">
                    <div class="flex justify-between items-center mb-4 drag-handle"
                        :class="{'cursor-move bg-slate-700/50 rounded p-1': isEditingLayout}">
                        <h3 class="text-slate-300 font-medium flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4">
                                </path>
                            </svg>
                            Á£ÅÁõòÁ©∫Èó¥‰∏é I/O ÁõëÊéß (Â§ßÁõò)
                        </h3>
                        <div class="flex items-center gap-4">
                            <span class="text-indigo-400 font-mono text-xl">{{ diskInfo?.percent || 0 }}%</span>
                            <button @click="collapsed.disk = !collapsed.disk"
                                class="text-slate-500 hover:text-white transition">
                                <svg class="w-4 h-4 transform transition-transform"
                                    :class="{ 'rotate-180': collapsed.disk }" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div v-show="!collapsed.disk">
                        <div class="w-full bg-slate-900 rounded-full h-6 mb-3 border border-slate-700">
                            <div class="bg-indigo-500 h-6 rounded-full transition-all duration-1000 relative overflow-hidden"
                                :style="{ width: (diskInfo?.percent || 0) + '%' }">
                                <div class="absolute inset-0 bg-white/20"
                                    style="background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent); background-size: 1rem 1rem;">
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between text-sm text-slate-400 font-mono">
                            <span>Â∑≤Áî®: {{ diskInfo?.used_gb || 0 }} GB</span>
                            <span>ËØª: {{ formatBytes(diskInfo?.read_speed || 0) }} | Âª∂: {{ diskInfo?.read_time || 0
                                }}ms</span>
                            <span>ÂÜô: {{ formatBytes(diskInfo?.write_speed || 0) }} | Âª∂: {{ diskInfo?.write_time || 0
                                }}ms</span>
                            <span>ÊÄªÂÖ±: {{ diskInfo?.total_gb || 0 }} GB</span>
                        </div>
                    </div>
                </div>

                <!-- Network Chart -->
                <div id="module-netChart"
                    class="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg lg:col-span-2">
                    <div class="flex justify-between items-center mb-2 drag-handle"
                        :class="{'cursor-move bg-slate-700/50 rounded p-1': isEditingLayout}">
                        <h3 class="text-slate-300 font-medium">ÂÖ®ÁΩëÂç°ÊÄªÊµÅÈáè (Bytes/s)</h3>
                        <button @click="collapsed.netChart = !collapsed.netChart"
                            class="text-slate-500 hover:text-white transition">
                            <svg class="w-4 h-4 transform transition-transform"
                                :class="{ 'rotate-180': collapsed.netChart }" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                    </div>
                    <div v-show="!collapsed.netChart" id="netChart" class="w-full h-64 mt-2"></div>
                </div>

                <!-- Advanced Network Stats -->
                <div id="module-netStats"
                    class="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg lg:col-span-2">
                    <div class="flex justify-between items-center mb-4 drag-handle"
                        :class="{'cursor-move bg-slate-700/50 rounded p-1': isEditingLayout}">
                        <h3 class="text-slate-300 font-medium flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z">
                                </path>
                            </svg>
                            ÁΩëÁªúÁä∂ÊÄÅ
                        </h3>
                        <button @click="collapsed.netStats = !collapsed.netStats"
                            class="text-slate-500 hover:text-white transition">
                            <svg class="w-4 h-4 transform transition-transform"
                                :class="{ 'rotate-180': collapsed.netStats }" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                    </div>

                    <div v-show="!collapsed.netStats" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- TCP Connections Map -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-slate-400">ÂΩìÂâçÊÄªËøûÊé•Êï∞</span>
                                <span class="font-mono text-xl text-white">{{ networkConnections.total_connections || 0
                                    }}</span>
                            </div>
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-sm text-slate-400">Âä®ÊÄÅËøûÊé•Êï∞ (ÊØè 3 Áßí)</span>
                                <div class="flex gap-3">
                                    <span class="text-emerald-400 font-mono text-sm">+{{
                                        networkConnections.rate?.new_per_3s || 0 }}</span>
                                    <span class="text-rose-400 font-mono text-sm">-{{
                                        networkConnections.rate?.closed_per_3s || 0 }}</span>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <div v-for="(val, key) in networkConnections.status_counts" :key="key"
                                    class="flex justify-between items-center bg-slate-900/50 px-3 py-1.5 rounded text-sm">
                                    <span class="text-slate-400 capitalize">{{ translateTcpStatus(key) }}</span>
                                    <span class="text-white font-mono">{{ val }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Interfaces List -->
                        <div class="overflow-y-auto max-h-64 pr-2 custom-scrollbar">
                            <div v-for="nic in networkInterfaces" :key="nic.name"
                                class="mb-3 bg-slate-900/50 p-3 rounded border border-slate-700/50">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-medium text-indigo-300">{{ nic.name }}</span>
                                    <span
                                        :class="nic.is_up ? 'bg-emerald-900 border-emerald-500 text-emerald-300' : 'bg-slate-800 border-slate-600 text-slate-400'"
                                        class="text-[10px] px-2 py-0.5 rounded-full border">
                                        {{ nic.is_up ? 'UP' : 'DOWN' }}
                                    </span>
                                </div>
                                <div class="text-xs text-slate-400 mt-2 space-y-1 font-mono">
                                    <div v-if="nic.mac" class="flex"><span class="w-10 text-slate-500">MAC</span> {{
                                        nic.mac }}</div>
                                    <div v-for="ip in nic.ipv4" class="flex"><span
                                            class="w-10 text-slate-500">IPv4</span> {{ ip }}</div>
                                    <div v-for="ip in nic.ipv6" class="flex"><span
                                            class="w-10 text-slate-500">IPv6</span> {{ ip }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Nginx Log Analyzer -->
                <div id="module-nginx"
                    class="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg lg:col-span-2">
                    <div class="flex flex-wrap justify-between items-center mb-4 drag-handle"
                        :class="{'cursor-move bg-slate-700/50 rounded p-1': isEditingLayout}">
                        <h3 class="text-slate-300 font-medium flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                            Nginx ËøêË°åÁä∂ÊÄÅ/Êó•ÂøóÂàÜÊûê
                        </h3>
                        <div class="flex items-center gap-4">
                            <!-- Status indicator -->
                            <div class="flex items-center gap-2">
                                <span :class="nginxStatus.running ? 'bg-emerald-500' : 'bg-rose-500'"
                                    class="w-2.5 h-2.5 rounded-full animate-pulse"></span>
                                <span class="text-sm font-mono"
                                    :class="nginxStatus.running ? 'text-emerald-400' : 'text-rose-400'">
                                    {{ nginxStatus.running ? `ËøêË°å‰∏≠ (PID: ${nginxStatus.pid})` : 'Â∑≤ÂÅúÊ≠¢' }}
                                </span>
                            </div>
                            <button @click="collapsed.nginx = !collapsed.nginx"
                                class="text-slate-500 hover:text-white transition">
                                <svg class="w-4 h-4 transform transition-transform"
                                    :class="{ 'rotate-180': collapsed.nginx }" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div v-show="!collapsed.nginx" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Configuration Form -->
                        <div class="lg:col-span-1 space-y-4">
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">access.log ÁªùÂØπË∑ØÂæÑ</label>
                                <div class="flex gap-2">
                                    <input type="text" v-model="nginxConfig.log_path"
                                        class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm text-white focus:border-indigo-500 focus:outline-none flex-grow">
                                    <button @click="saveNginxConfig"
                                        class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-sm transition shrink-0">‰øùÂ≠ò</button>
                                </div>
                            </div>
                            <button @click="analyzeNginxLogs" :disabled="nginxLoading"
                                class="w-full py-2 bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50 text-white rounded text-sm transition flex items-center justify-center gap-2">
                                <svg v-if="nginxLoading" class="animate-spin h-4 w-4 text-white" fill="none"
                                    viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                                {{ nginxLoading ? 'Ê≠£Âú®ÊäΩÊ†∑ÂàÜÊûê...' : 'Top IP ‰∏éÂú∞ÁêÜÊü•ËØ¢' }}
                            </button>
                            <p v-if="nginxLogResult.error" class="text-rose-400 text-xs">{{ nginxLogResult.error }}</p>
                            <p v-if="nginxLogResult.total_analyzed_lines > 0" class="text-slate-400 text-xs">
                                ÊàêÂäüÊäΩÂèñÂπ∂ÂàÜÊûê‰∫ÜÊñá‰ª∂Êú´Â∞æ {{ nginxLogResult.total_analyzed_lines }} Êù°ËÆ∞ÂΩï„ÄÇ</p>
                        </div>

                        <!-- Top IPs Table -->
                        <div class="lg:col-span-2 overflow-x-auto">
                            <div class="max-h-64 overflow-y-auto custom-scrollbar">
                                <table class="w-full text-sm text-left text-slate-300">
                                    <thead class="text-xs text-slate-400 bg-slate-900/50 sticky top-0">
                                        <tr>
                                            <th class="px-4 py-2 font-medium">IP Âú∞ÂùÄ</th>
                                            <th class="px-4 py-2 font-medium">ËÆøÈóÆÊ¨°Êï∞</th>
                                            <th class="px-4 py-2 font-medium">Âú∞ÁêÜ‰ΩçÁΩÆ</th>
                                            <th class="px-4 py-2 font-medium">ËøêËê•ÂïÜ (ISP)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-if="nginxLogResult.top_ips?.length === 0"
                                            class="border-b border-slate-700/50">
                                            <td colspan="4" class="px-4 py-6 text-center text-slate-500">
                                                Â∞öÊó†ÂàÜÊûêÊï∞ÊçÆ„ÄÇËØ∑Á°ÆËÆ§ËÆøÈóÆÊó•ÂøóË∑ØÂæÑÊó†ËØØÂêéÔºåÁÇπÂáªÂ∑¶‰æßÂºÄÂßãËß£ÊûêÊåâÈíÆ„ÄÇ</td>
                                        </tr>
                                        <tr v-for="row in nginxLogResult.top_ips" :key="row.ip"
                                            class="border-b border-slate-700/50 hover:bg-slate-700/30">
                                            <td class="px-4 py-2 font-mono text-indigo-300">{{ row.ip }}</td>
                                            <td class="px-4 py-2">{{ row.count }}</td>
                                            <td class="px-4 py-2 text-xs">
                                                <span v-if="row.country !== 'Unknown'" class="mr-1">üåç</span>
                                                {{ row.country === 'Unknown' ? 'Êú™Áü•' : row.country }}<span
                                                    v-if="row.city && row.city !== 'Unknown'">Ôºå{{ row.city }}</span>
                                            </td>
                                            <td class="px-4 py-2 text-xs truncate max-w-[120px]" :title="row.isp">{{
                                                row.isp }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Process Manager -->
                <div id="module-process"
                    class="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg lg:col-span-2">
                    <div class="flex justify-between items-center mb-4 drag-handle"
                        :class="{'cursor-move bg-slate-700/50 rounded p-1': isEditingLayout}">
                        <h3 class="text-slate-300 font-medium flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Á≥ªÁªüËøõÁ®ãÁÆ°ÁêÜ (ÊåâÁâ©ÁêÜÂÜÖÂ≠òÂÄíÂ∫è Top 100)
                        </h3>
                        <div class="flex items-center gap-2">
                            <button @click="fetchProcesses" class="p-2 text-slate-400 hover:text-white transition">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                    </path>
                                </svg>
                            </button>
                            <button @click="collapsed.process = !collapsed.process"
                                class="text-slate-500 hover:text-white transition">
                                <svg class="w-4 h-4 transform transition-transform"
                                    :class="{ 'rotate-180': collapsed.process }" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div v-show="!collapsed.process"
                        class="overflow-x-auto max-h-[400px] overflow-y-auto custom-scrollbar border border-slate-700 rounded-lg">
                        <table class="w-full text-sm text-left text-slate-300">
                            <thead class="text-xs text-slate-400 bg-slate-900 sticky top-0 z-10">
                                <tr>
                                    <th class="px-4 py-3 font-medium cursor-pointer">PID</th>
                                    <th class="px-4 py-3 font-medium">ËøõÁ®ãÂêçÁß∞ / ÊúçÂä°Â§áÊ≥®</th>
                                    <th class="px-4 py-3 font-medium">Áî®Êà∑</th>
                                    <th class="px-4 py-3 font-medium">ÁõëÂê¨Á´ØÂè£</th>
                                    <th class="px-4 py-3 font-medium">CPU(%)</th>
                                    <th class="px-4 py-3 font-medium">ÂÜÖÂ≠ò(MB)</th>
                                    <th class="px-4 py-3 font-medium text-right">Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="proc in processes" :key="proc.pid"
                                    class="border-b border-slate-700/50 hover:bg-slate-700/30 transition">
                                    <td class="px-4 py-2 font-mono text-slate-400">{{ proc.pid }}</td>
                                    <td class="px-4 py-2">
                                        <div class="font-medium text-indigo-300">{{ proc.name }}</div>
                                        <div v-if="proc.description" class="text-[10px] text-emerald-400/80">{{
                                            proc.description }}</div>
                                    </td>
                                    <td class="px-4 py-2 text-xs truncate max-w-[100px]">{{ proc.user }}</td>
                                    <td class="px-4 py-2 font-mono text-xs text-sky-400">{{ proc.ports.join(', ') || '-'
                                        }}</td>
                                    <td class="px-4 py-2"><span
                                            :class="proc.cpu_percent > 50 ? 'text-rose-400 font-bold' : ''">{{
                                            proc.cpu_percent.toFixed(1) }}</span></td>
                                    <td class="px-4 py-2"><span
                                            :class="proc.memory_mb > 500 ? 'text-rose-400 font-bold' : ''">{{
                                            proc.memory_mb }}</span></td>
                                    <td class="px-4 py-2 text-right">
                                        <button @click="killProcess(proc.pid, proc.name)"
                                            class="px-3 py-1 bg-red-500/10 hover:bg-red-500/30 border border-red-500/20 text-red-400 hover:text-red-300 rounded transition text-xs font-semibold shadow-sm">
                                            Âº∫Ë°åÁªìÊùü
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Docker Monitor -->
                <div id="module-docker" class="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
                    <div class="flex justify-between items-center mb-4 drag-handle"
                        :class="{'cursor-move bg-slate-700/50 rounded p-1': isEditingLayout}">
                        <h3 class="text-slate-300 font-medium flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 002-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                </path>
                            </svg>
                            Docker ÂÆπÂô®Áä∂ÊÄÅ
                        </h3>
                        <button @click="fetchDocker" class="text-slate-400 hover:text-white transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                </path>
                            </svg>
                        </button>
                    </div>
                    <div v-if="!dockerInfo.installed" class="text-slate-500 text-sm text-center py-6">
                        Â∞öÊú™Âú®Á≥ªÁªü‰∏≠Êé¢ÊµãÂà∞ Docker ÂºïÊìéÊ†∏ÂøÉÊàñÂΩìÂâçË¥¶Êà∑Êó†ÊùÉÈôêÂ≠òÂèñ„ÄÇ
                    </div>
                    <div v-else-if="dockerInfo.containers.length === 0" class="text-slate-500 text-sm text-center py-6">
                        Ê≤°Êúâ‰ªª‰ΩïÊ≠£Â∏∏ÊåÇËΩΩËÆ∞ÂΩï‰∏≠ÁöÑÂÆπÂô®ÂÆû‰æã„ÄÇ
                    </div>
                    <div v-else class="space-y-3 overflow-y-auto max-h-64 custom-scrollbar">
                        <div v-for="c in dockerInfo.containers" :key="c.ID"
                            class="bg-slate-900 border border-slate-700 rounded p-3 flex justify-between items-center">
                            <div>
                                <div class="text-indigo-300 font-medium text-sm">{{ c.Names }}</div>
                                <div class="text-xs text-slate-400 font-mono mt-1">{{ c.Image }}</div>
                            </div>
                            <div class="text-right">
                                <span
                                    :class="c.State === 'running' ? 'bg-emerald-900 text-emerald-300' : 'bg-slate-800 text-slate-400'"
                                    class="text-[10px] px-2 py-0.5 rounded-full border border-slate-700 uppercase">
                                    {{ c.State }}
                                </span>
                                <div class="text-xs text-slate-500 mt-1">{{ c.Status }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- File Manager -->
                <div id="module-files"
                    class="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg flex flex-col h-full lg:col-span-2">
                    <div class="flex justify-between items-center mb-4 drag-handle"
                        :class="{'cursor-move bg-slate-700/50 rounded p-1': isEditingLayout}">
                        <h3 class="text-slate-300 font-medium flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z">
                                </path>
                            </svg>
                            Web Êñá‰ª∂ÁÆ°ÁêÜÊ†ë
                        </h3>
                        <button @click="fetchFiles(currentPath.value || '/')"
                            class="text-slate-400 hover:text-white transition group relative">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                </path>
                            </svg>
                        </button>
                    </div>

                    <div class="flex gap-2 mb-3">
                        <button @click="fetchFiles(parentPath)"
                            class="px-2 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-slate-300 transition"
                            title="ËøîÂõû‰∏äÁ∫ßÁõÆÂΩï">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                        </button>
                        <input type="text" v-model="currentPath" @keyup.enter="fetchFiles(currentPath)"
                            class="w-full bg-slate-900 border border-slate-700 text-slate-300 text-sm rounded px-3 py-1 focus:outline-none focus:border-indigo-500">

                        <button @click="$refs.fileUploadInput.click()"
                            class="px-3 py-1.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded text-sm transition font-medium flex-shrink-0 flex items-center gap-1"
                            title="‰∏ä‰º†Êñá‰ª∂Âà∞ÂΩìÂâçÁõÆÂΩï">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                            </svg>
                            <span>‰∏ä‰º†</span>
                        </button>
                        <input type="file" ref="fileUploadInput" @change="handleFileUpload" class="hidden">
                    </div>

                    <div
                        class="flex-grow overflow-y-auto max-h-[300px] border border-slate-700 bg-slate-900 rounded custom-scrollbar">
                        <div v-if="fileError" class="p-4 text-center text-rose-400 text-sm">{{ fileError }}</div>
                        <ul v-else class="text-sm">
                            <li v-for="f in fileItems" :key="f.name"
                                class="flex justify-between items-center px-4 py-2 border-b border-slate-800 hover:bg-slate-800/80 transition group">
                                <div class="flex items-center gap-2 cursor-pointer truncate mr-4 max-w-[60%]"
                                    @click="f.is_dir ? fetchFiles(f.absolute_path) : null">
                                    <svg v-if="f.is_dir" class="w-4 h-4 text-indigo-400 flex-shrink-0"
                                        fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z">
                                        </path>
                                    </svg>
                                    <svg v-else class="w-4 h-4 text-slate-400 flex-shrink-0" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                    <span :class="f.is_dir ? 'text-indigo-300' : 'text-slate-300'" class="truncate">{{
                                        f.name }}</span>
                                </div>
                                <div class="flex items-center gap-4 text-xs">
                                    <span v-if="!f.is_dir" class="text-slate-500 font-mono">{{ (f.size /
                                        1024).toFixed(1) }} KB</span>
                                    <div class="opacity-0 group-hover:opacity-100 transition flex gap-2">
                                        <button v-if="!f.is_dir" @click="downloadFile(f.absolute_path)"
                                            class="text-emerald-400 hover:text-emerald-300" title="‰∏ãËΩΩ">‰∏ãËΩΩ</button>
                                        <button @click="deleteFile(f.absolute_path, f.is_dir)"
                                            class="text-rose-400 hover:text-rose-300" title="Âà†Èô§">Âà†Èô§</button>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- System Logs (New) -->
            <div id="module-syslogs"
                class="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg lg:col-span-2">
                <div class="flex flex-wrap justify-between items-center mb-4 drag-handle"
                    :class="{'cursor-move bg-slate-700/50 rounded p-1': isEditingLayout}">
                    <h3 class="text-slate-300 font-medium flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                            </path>
                        </svg>
                        Linux Á≥ªÁªüÂëäË≠¶Êó•Âøó
                    </h3>
                    <div class="flex items-center gap-2">
                        <select v-model="logSeverity" @change="fetchLogs"
                            class="bg-slate-900 border border-slate-700 text-xs rounded text-slate-300 px-2 py-1 focus:outline-none focus:border-indigo-500">
                            <option value="ALL">ÂÖ®ÈÉ® (ALL)</option>
                            <option value="INFO">‰ø°ÊÅØ (INFO)</option>
                            <option value="WARNING">Ë≠¶Âëä (WARN)</option>
                            <option value="ERROR">‰∏•Èáç (ERR/CRIT)</option>
                        </select>
                        <button @click="fetchLogs"
                            class="p-1 px-2 text-slate-400 hover:text-white transition bg-slate-700 rounded text-xs ml-1">
                            Âà∑Êñ∞
                        </button>
                        <button @click="collapsed.syslogs = !collapsed.syslogs"
                            class="text-slate-500 hover:text-white transition ml-2">
                            <svg class="w-4 h-4 transform transition-transform"
                                :class="{ 'rotate-180': collapsed.syslogs }" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div v-show="!collapsed.syslogs" class="overflow-x-auto">
                    <div
                        class="max-h-64 overflow-y-auto custom-scrollbar bg-slate-900 rounded border border-slate-700 p-2 relative">
                        <div v-if="systemLogs.length === 0" class="text-center text-slate-500 py-6 text-sm">
                            ÊöÇÊó†ÂåπÈÖçÁöÑÁ≥ªÁªüÂëäË≠¶Êó•Âøó...</div>
                        <div v-for="(log, idx) in systemLogs" :key="idx"
                            class="text-xs font-mono border-b flex gap-3 hover:bg-slate-800/80 p-2"
                            :class="idx !== systemLogs.length-1 ? 'border-slate-800/50' : 'border-transparent'">
                            <span class="text-slate-500 flex-shrink-0 w-36">{{ log.time }}</span>
                            <span class="text-indigo-400 flex-shrink-0 w-24 truncate" :title="log.source">{{ log.source
                                }}</span>
                            <span
                                :class="{'text-rose-400': logSeverity === 'ERROR' || log.message.toLowerCase().includes('err') || log.message.toLowerCase().includes('fail') || log.message.toLowerCase().includes('crit'), 'text-emerald-400': logSeverity === 'INFO'}"
                                class="text-slate-300 break-all">{{ log.message }}</span>
                        </div>
                    </div>
                    <div class="text-[10px] text-slate-500 mt-2 text-right">Êó•ÂøóÊï∞ÊçÆÊ∫ê: {{ logSource || 'Êú™Áü•' }}</div>
                </div>
            </div>

        </div>

        <!-- Password Change Modal -->
        <div v-if="showPwdModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center">
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-xl w-full max-w-sm">
                <h3 class="text-xl font-bold text-white mb-4">‰øÆÊîπÁÆ°ÁêÜÂëòÂè£‰ª§‰∏éË∫´‰ªΩ</h3>
                <div class="space-y-4">
                    <div v-if="pwdMessage" :class="pwdMessage.type === 'error' ? 'text-rose-400' : 'text-emerald-400'"
                        class="text-sm">
                        {{ pwdMessage.text }}
                    </div>
                    <div>
                        <label class="block text-sm text-slate-300 mb-1">Á≥ªÁªüÂΩìÂâçÂØÜÁ†Å</label>
                        <input type="password" v-model="pwdForm.old"
                            class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-300 mb-1">ËÆæÁΩÆÊñ∞Áî®Êà∑Âêç</label>
                        <input type="text" v-model="pwdForm.username"
                            class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-300 mb-1">ËæìÂÖ•Êñ∞ÂØÜÁ†Å (Ëá≥Â∞ë6‰Ωç)</label>
                        <input type="password" v-model="pwdForm.new1"
                            class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-300 mb-1">ÂÜçÊ¨°Á°ÆËÆ§Êñ∞ÂØÜÁ†Å</label>
                        <input type="password" v-model="pwdForm.new2"
                            class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:border-indigo-500">
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button @click="showPwdModal = false"
                            class="px-4 py-2 text-slate-300 hover:text-white transition">ÂèñÊ∂à</button>
                        <button @click="changePassword"
                            class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded transition shadow">Á°ÆËÆ§‰øÆÊîπ</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue

        createApp({
            setup() {
                const isAuthenticated = ref(false)
                const loginForm = ref({ username: '', password: '' })
                const loginError = ref('')
                const timeRange = ref(60)
                const customTime = ref({ start: '', end: '' })
                const fileUploadInput = ref(null)

                const showPwdModal = ref(false)
                const currentUsername = ref('')
                const pwdForm = ref({ old: '', username: '', new1: '', new2: '' })
                const pwdMessage = ref(null)
                const isDefaultPassword = ref(false)

                const collapsed = ref({
                    cpu: false, mem: false, disk: false, netChart: false, netStats: false,
                    nginx: false, process: false, docker: false, files: false, syslogs: false
                })

                const formatBytes = (value) => {
                    if (!value || value === 0) return '0 B/s';
                    const k = 1024;
                    const sizes = ['B/s', 'KB/s', 'MB/s', 'GB/s'];
                    const i = Math.floor(Math.log(Math.abs(value)) / Math.log(k));
                    return parseFloat((value / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }

                const isEditingLayout = ref(false)
                let sortableInstance = null

                const systemLogs = ref([])
                const logSeverity = ref('WARNING')
                const logSource = ref('')

                const toggleEditLayout = () => {
                    isEditingLayout.value = !isEditingLayout.value;
                    if (isEditingLayout.value) {
                        if (!sortableInstance) {
                            const el = document.getElementById('dashboard-grid');
                            if (el) {
                                sortableInstance = Sortable.create(el, {
                                    animation: 150,
                                    handle: '.drag-handle',
                                    ghostClass: 'opacity-50',
                                    disabled: false
                                });
                            }
                        } else {
                            sortableInstance.option("disabled", false);
                        }
                    } else {
                        if (sortableInstance) {
                            sortableInstance.option("disabled", true);
                            const el = document.getElementById('dashboard-grid');
                            if (el) {
                                const children = Array.from(el.children);
                                const layout = children.map(child => child.id).filter(id => id);
                                saveLayout(layout);
                            }
                        }
                    }
                }

                const saveLayout = async (layout) => {
                    try {
                        await fetch('/api/system/config/layout', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...getTokenHeaders() },
                            body: JSON.stringify({ layout })
                        });
                    } catch (err) {
                        console.error('Failed to save layout', err)
                    }
                }

                const loadLayout = async () => {
                    try {
                        const res = await fetch('/api/system/config/layout', { headers: getTokenHeaders() });
                        if (res.ok) {
                            const layout = await res.json();
                            if (Array.isArray(layout) && layout.length > 0) {
                                const el = document.getElementById('dashboard-grid');
                                if (el) {
                                    layout.forEach(id => {
                                        const child = document.getElementById(id);
                                        if (child) el.appendChild(child);
                                    });
                                }
                            }
                        }
                    } catch (err) {
                        console.error('Failed to load layout', err)
                    }
                }

                const fetchLogs = async () => {
                    if (!isAuthenticated.value) return;
                    try {
                        const res = await fetch(`/api/system/logs?severity=${logSeverity.value}&lines=100`, { headers: getTokenHeaders() });
                        if (res.ok) {
                            const data = await res.json();
                            systemLogs.value = data.logs || [];
                            logSource.value = data.source || '';
                        }
                    } catch (err) {
                        console.error("Failed to fetch logs", err)
                    }
                }

                const diskInfo = ref({ total_gb: 0, used_gb: 0, percent: 0, read_speed: 0, write_speed: 0, read_time: 0, write_time: 0 })
                const diskPrev = ref(null)

                const networkInterfaces = ref([])
                const networkConnections = ref({ status_counts: {}, total_connections: 0, rate: { new_per_3s: 0, closed_per_3s: 0 } })

                const translateTcpStatus = (status) => {
                    const map = {
                        'LISTEN': 'ÁõëÂê¨‰∏≠ (LISTEN)',
                        'ESTABLISHED': 'Â∑≤Âª∫Á´ã (ESTAB)',
                        'TIME_WAIT': 'Á≠âÂæÖÈáäÊîæ (TIME_WAIT)',
                        'CLOSE_WAIT': 'Á≠âÂæÖÂÖ≥Èó≠ (CLOSE_WAIT)',
                        'SYN_SENT': 'ËØ∑Ê±ÇÂèëÈÄÅ (SYN_SENT)',
                        'SYN_RECV': 'ËØ∑Ê±ÇÊé•Êî∂ (SYN_RECV)',
                        'FIN_WAIT1': 'ÁªàÊ≠¢Á≠âÂæÖ1 (FIN_W1)',
                        'FIN_WAIT2': 'ÁªàÊ≠¢Á≠âÂæÖ2 (FIN_W2)',
                        'NONE': 'Êó†Áä∂ÊÄÅ (NONE)',
                        'LAST_ACK': 'Á°ÆËÆ§ÁªàÊ≠¢ (LAST_ACK)',
                        'CLOSED': 'Â∑≤ÈùôÈªò (CLOSED)'
                    };
                    return map[status.toUpperCase()] || status;
                }

                const nginxStatus = ref({ running: false, pid: null, uptime_seconds: 0 })
                const nginxConfig = ref({ log_path: '/var/log/nginx/access.log' })
                const nginxLogResult = ref({ error: null, total_analyzed_lines: 0, top_ips: [] })
                const nginxLoading = ref(false)

                const processes = ref([])

                const dockerInfo = ref({ installed: false, containers: [] })
                const currentPath = ref(navigator.platform.indexOf('Win') > -1 ? 'C:\\' : '/')
                const parentPath = ref('/')
                const fileItems = ref([])
                const fileError = ref(null)

                let cpuChartInstance = null
                let memChartInstance = null
                let netChartInstance = null
                let intervalId = null

                const checkToken = async () => {
                    const token = localStorage.getItem('access_token')
                    if (!token) return

                    try {
                        const res = await fetch('/api/verify_token', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        })
                        if (res.ok) {
                            isAuthenticated.value = true
                            const data = await res.json()
                            isDefaultPassword.value = data.is_default_password
                            currentUsername.value = data.username || 'admin'
                            pwdForm.value.username = currentUsername.value

                            if (isDefaultPassword.value) {
                                setTimeout(() => {
                                    pwdMessage.value = { type: 'error', text: 'ÂÆâÂÖ®Ë≠¶ÂëäÔºöÂΩìÂâçÁÆ°ÁêÜÂëòÊ≠£Âú®‰ΩøÁî®Á≥ªÁªüÈªòËÆ§Âº±ÂØÜÁ†ÅÊàñÈªòËÆ§Áî®Êà∑ÂêçÔºåÂ≠òÂú®Ë¢´ÂÖ•‰æµÁöÑÂ∑®Â§ßÈ£éÈô©ÔºÅËØ∑Á´ãÂç≥ÂÆåÊàê‰øÆÊîπ„ÄÇ' }
                                    showPwdModal.value = true
                                }, 1500)
                            }
                        } else {
                            localStorage.removeItem('access_token')
                        }
                    } catch (err) {
                        console.error(err)
                    }
                }

                const login = async () => {
                    loginError.value = ''
                    const formData = new URLSearchParams()
                    formData.append('username', loginForm.value.username)
                    formData.append('password', loginForm.value.password)

                    try {
                        const res = await fetch('/api/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: formData
                        })
                        const data = await res.json()

                        if (res.ok) {
                            localStorage.setItem('access_token', data.access_token)
                            isAuthenticated.value = true
                            loginForm.value.password = '' // clear

                            // Check token to load username and trigger default password warning immediately
                            await checkToken()

                            // When authenticated, init dashboard
                            Vue.nextTick(() => {
                                loadLayout()
                                initCharts()
                                fetchLogs()
                                startAutoRefresh()
                            })
                        } else {
                            loginError.value = data.detail || 'Login failed'
                        }
                    } catch (err) {
                        loginError.value = 'Network error'
                    }
                }

                const logout = () => {
                    localStorage.removeItem('access_token')
                    isAuthenticated.value = false
                    stopAutoRefresh()
                }

                const openPwdModal = () => {
                    pwdForm.value.username = currentUsername.value || 'admin'
                    showPwdModal.value = true
                }

                const changePassword = async () => {
                    pwdMessage.value = null
                    if (!pwdForm.value.old || !pwdForm.value.new1 || !pwdForm.value.new2 || !pwdForm.value.username) {
                        pwdMessage.value = { type: 'error', text: 'ÊâÄÊúâËæìÂÖ•Ê°ÜÂùáÂøÖÈ°ªÂ°´ÂÜôÂÆåÊï¥ÔºÅ' }
                        return
                    }
                    if (pwdForm.value.new1 !== pwdForm.value.new2) {
                        pwdMessage.value = { type: 'error', text: '‰∏§Ê¨°ËæìÂÖ•ÁöÑÊñ∞ÂØÜÁ†Å‰∏ç‰∏ÄËá¥ÔºÅ' }
                        return
                    }
                    if (pwdForm.value.new1.length < 6) {
                        pwdMessage.value = { type: 'error', text: 'Êñ∞ÂØÜÁ†Å‰∏çËÉΩÂ∞ë‰∫é 6 ‰ΩçÊúâÊïàÈïøÂ∫¶ÔºÅ' }
                        return
                    }

                    try {
                        const res = await fetch('/api/user/password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...getTokenHeaders() },
                            body: JSON.stringify({
                                old_password: pwdForm.value.old,
                                new_username: pwdForm.value.username,
                                new_password: pwdForm.value.new1
                            })
                        })
                        const data = await res.json()
                        if (res.ok) {
                            alert(data.message)
                            showPwdModal.value = false
                            pwdForm.value = { old: '', username: '', new1: '', new2: '' }
                            logout()
                        } else {
                            pwdMessage.value = { type: 'error', text: data.detail || '‰ø°ÊÅØ‰øÆÊîπËØ∑Ê±ÇË¢´È©≥Âõû„ÄÇ' }
                        }
                    } catch (err) {
                        pwdMessage.value = { type: 'error', text: 'ËØ∑Ê±ÇÂ§±Ë¥•ÔºöÂêéÂè∞È™åËØÅÊåÇËµ∑ÊàñÁΩëÁªúÂºÇÂ∏∏„ÄÇ' }
                    }
                }

                const clearHistory = async () => {
                    if (!confirm("Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÊ∏ÖÁ©∫Êï∞ÊçÆÂ∫ì‰∏≠ÊâÄÊúâÂÇ®Â≠òÁöÑ CPU„ÄÅÂÜÖÂ≠ò„ÄÅÁΩëÁªúÁ≠âÂéÜÂè≤ËøêË°åËΩ®ËøπÊï∞ÊçÆ„ÄÇ\n\nÊÇ®Á°ÆÂÆöË¶ÅËøõË°åËØ•Ê∏ÖÁêÜÂä®‰ΩúÂêóÔºü")) return
                    try {
                        const res = await fetch('/api/system/metrics/history', {
                            method: 'DELETE',
                            headers: getTokenHeaders()
                        })
                        if (res.ok) {
                            alert("ÂéÜÂè≤Êï∞ÊçÆÂ∑≤Âº∫ÂäõÊ∏ÖÁ©∫ÔºÅ")
                            fetchMetricsHistory()
                        } else {
                            const data = await res.json()
                            alert(`Ê∏ÖÁêÜÂ§±Ë¥•Ôºö${data.message}`)
                        }
                    } catch (err) {
                        alert("Ê∏ÖÁ©∫ËØ∑Ê±ÇÂèëÁîüÁΩëÁªúÂºÇÂ∏∏„ÄÇ")
                    }
                }

                const getTokenHeaders = () => {
                    return {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                }

                const initCharts = () => {
                    if (!document.getElementById('cpuChart')) return
                    cpuChartInstance = echarts.init(document.getElementById('cpuChart'), 'dark', { renderer: 'canvas' })
                    memChartInstance = echarts.init(document.getElementById('memChart'), 'dark', { renderer: 'canvas' })
                    netChartInstance = echarts.init(document.getElementById('netChart'), 'dark', { renderer: 'canvas' })

                    // Transparent background for dark mode charts to blend with tailwind slate-800
                    const commonOptions = {
                        backgroundColor: 'transparent',
                        tooltip: { trigger: 'axis' },
                        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                        xAxis: { type: 'time', splitLine: { show: false } },
                        yAxis: { type: 'value', splitLine: { lineStyle: { color: '#334155' } } },
                    }

                    cpuChartInstance.setOption({
                        ...commonOptions,
                        color: ['#6366f1'], // Indigo 500
                        series: [{ name: 'CPU %', type: 'line', showSymbol: false, areaStyle: { opacity: 0.1 }, data: [] }]
                    })

                    memChartInstance.setOption({
                        ...commonOptions,
                        color: ['#10b981'], // Emerald 500
                        series: [{ name: 'Mem MB', type: 'line', showSymbol: false, areaStyle: { opacity: 0.1 }, data: [] }]
                    })

                    netChartInstance.setOption({
                        ...commonOptions,
                        color: ['#0ea5e9', '#f43f5e'], // Sky 500, Rose 500
                        yAxis: {
                            type: 'value',
                            splitLine: { lineStyle: { color: '#334155' } },
                            axisLabel: { formatter: (val) => formatBytes(val) }
                        },
                        tooltip: {
                            trigger: 'axis',
                            formatter: function (params) {
                                let res = params[0].axisValueLabel + '<br/>';
                                params.forEach(function (item) {
                                    res += item.marker + item.seriesName + ': ' + formatBytes(item.value[1]) + '<br/>';
                                });
                                return res;
                            }
                        },
                        legend: { data: ['Sent', 'Recv'], textStyle: { color: '#cbd5e1' } },
                        series: [
                            { name: 'Sent', type: 'line', showSymbol: false, data: [] },
                            { name: 'Recv', type: 'line', showSymbol: false, data: [] }
                        ]
                    })

                    window.addEventListener('resize', () => {
                        cpuChartInstance?.resize()
                        memChartInstance?.resize()
                        netChartInstance?.resize()
                    })
                }

                const fetchMetricsHistory = async () => {
                    if (!isAuthenticated.value) return
                    try {
                        let url = `/api/system/metrics/history?minutes=${timeRange.value === 'custom' ? 60 : timeRange.value}`
                        if (timeRange.value === 'custom' && customTime.value.start && customTime.value.end) {
                            const startIso = new Date(customTime.value.start).toISOString()
                            const endIso = new Date(customTime.value.end).toISOString()
                            url = `/api/system/metrics/history?start_time=${startIso}&end_time=${endIso}`
                        }

                        const res = await fetch(url, {
                            headers: getTokenHeaders()
                        })
                        if (res.status === 401) return logout()

                        const data = await res.json()

                        // Construct time series data arrays
                        const cpuData = data.timestamps.map((t, i) => [new Date(t), data.cpu[i]])
                        const memData = data.timestamps.map((t, i) => [new Date(t), data.memory_used_mb[i]])
                        const netSentData = data.timestamps.map((t, i) => [new Date(t), data.net_sent_speed_bps[i]])
                        const netRecvData = data.timestamps.map((t, i) => [new Date(t), data.net_recv_speed_bps[i]])

                        cpuChartInstance?.setOption({ series: [{ data: cpuData }] })

                        // Update memory yAxis max to total memory intelligently
                        memChartInstance?.setOption({
                            yAxis: { max: Math.ceil(data.memory_total_mb) },
                            series: [{ data: memData }]
                        })

                        netChartInstance?.setOption({
                            series: [
                                { name: 'Sent', data: netSentData },
                                { name: 'Recv', data: netRecvData }
                            ]
                        })

                    } catch (err) {
                        console.error("Failed to fetch metrics", err)
                    }
                }

                const fetchRealtimeSystem = async () => {
                    if (!isAuthenticated.value) return
                    try {
                        const res = await fetch('/api/system/metrics/realtime', { headers: getTokenHeaders() })
                        if (res.ok) {
                            const data = await res.json()
                            const now = Date.now()
                            if (diskPrev.value && data.disk.io_read_bytes !== undefined) {
                                const timeDiff = (now - diskPrev.value.timestamp) / 1000
                                if (timeDiff > 0) {
                                    data.disk.read_speed = (data.disk.io_read_bytes - diskPrev.value.io_read_bytes) / timeDiff
                                    data.disk.write_speed = (data.disk.io_write_bytes - diskPrev.value.io_write_bytes) / timeDiff

                                    const rTimeDiff = data.disk.io_read_time - diskPrev.value.io_read_time
                                    const wTimeDiff = data.disk.io_write_time - diskPrev.value.io_write_time

                                    data.disk.read_time = Math.max(0, rTimeDiff / timeDiff).toFixed(1)
                                    data.disk.write_time = Math.max(0, wTimeDiff / timeDiff).toFixed(1)
                                }
                            }
                            diskInfo.value = data.disk
                            diskPrev.value = { ...data.disk, timestamp: now }
                        }
                    } catch (err) {
                        console.error("Failed to fetch real-time disk", err)
                    }
                }

                const fetchRealtimeNetwork = async () => {
                    if (!isAuthenticated.value) return
                    try {
                        const resIf = await fetch('/api/network/interfaces', { headers: getTokenHeaders() })
                        if (resIf.ok) networkInterfaces.value = await resIf.json()

                        const resConn = await fetch('/api/network/connections', { headers: getTokenHeaders() })
                        if (resConn.ok) networkConnections.value = await resConn.json()
                    } catch (err) {
                        console.error("Failed to fetch network real-time data", err)
                    }
                }

                const fetchNginxStatus = async () => {
                    if (!isAuthenticated.value) return
                    try {
                        const res = await fetch('/api/nginx/status', { headers: getTokenHeaders() })
                        if (res.ok) nginxStatus.value = await res.json()
                    } catch (err) {
                        console.error("Failed to fetch Nginx status", err)
                    }
                }

                const fetchNginxConfig = async () => {
                    if (!isAuthenticated.value) return
                    try {
                        const res = await fetch('/api/nginx/config', { headers: getTokenHeaders() })
                        if (res.ok) nginxConfig.value = await res.json()
                    } catch (err) {
                        console.error("Failed to get config")
                    }
                }

                const fetchProcesses = async () => {
                    if (!isAuthenticated.value) return
                    try {
                        const res = await fetch('/api/process/list', { headers: getTokenHeaders() })
                        if (res.ok) processes.value = await res.json()
                    } catch (err) {
                        console.error("Failed to fetch processes")
                    }
                }

                const killProcess = async (pid, name) => {
                    if (!confirm(`!! Âç±Èô©Êìç‰Ωú !!\nÊÇ®Á°ÆÂÆöË¶ÅÂº∫Ë°åÁªìÊùü ${name} ËøõÁ®ãÂêó (PID: ${pid})Ôºü\nÊ≠§Êìç‰Ωú‰∏çÂèØÈÄÜÊàñËá¥Á≥ªÁªüÂÖ≥ÈîÆÊúçÂä°‰∏ßÂ§±ÂìçÂ∫î„ÄÇ`)) return

                    try {
                        const res = await fetch(`/api/process/kill/${pid}`, { method: 'POST', headers: getTokenHeaders() })
                        const data = await res.json()
                        if (res.ok) {
                            alert(data.message)
                            fetchProcesses()
                        } else {
                            alert(`ÊâßË°åÈîôËØØ: ${data.detail}`)
                        }
                    } catch (err) {
                        alert("ÊùÄËøõÁ®ãÊúüÈó¥Âá∫Áé∞Êú¨Âú∞ÊàñÁΩëÁªúÂºÇÂ∏∏„ÄÇ")
                    }
                }

                const saveNginxConfig = async () => {
                    try {
                        await fetch('/api/nginx/config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...getTokenHeaders() },
                            body: JSON.stringify({ log_path: nginxConfig.value.log_path })
                        })
                        alert('Â∑≤‰øùÂ≠ò Nginx Êó•ÂøóÁªùÂØπË∑ØÂæÑ„ÄÇ')
                    } catch (err) {
                        alert('‰øùÂ≠òÂ§±Ë¥•„ÄÇ')
                    }
                }

                const analyzeNginxLogs = async () => {
                    if (!isAuthenticated.value || nginxLoading.value) return

                    nginxLoading.value = true
                    nginxLogResult.value.error = null

                    try {
                        const res = await fetch('/api/nginx/analyze?lines=5000', { headers: getTokenHeaders() })
                        const data = await res.json()
                        if (res.ok && !data.error) {
                            nginxLogResult.value = data
                        } else {
                            nginxLogResult.value.error = data.error || 'ÂèëÁîü‰∫ÜÊú™Áü•ÁöÑËß£ÊûêÈîôËØØ„ÄÇ'
                        }
                    } catch (err) {
                        nginxLogResult.value.error = 'Êé•Âè£ËØ∑Ê±ÇÊñ≠ÂºÄ„ÄÇ'
                    } finally {
                        nginxLoading.value = false
                    }
                }

                const fetchDocker = async () => {
                    if (!isAuthenticated.value) return
                    try {
                        const res = await fetch('/api/manager/docker/containers', { headers: getTokenHeaders() })
                        if (res.ok) dockerInfo.value = await res.json()
                    } catch (err) {
                        console.error('Failed to get docker info')
                    }
                }

                const fetchFiles = async (path) => {
                    if (!isAuthenticated.value) return
                    fileError.value = null
                    try {
                        const res = await fetch(`/api/manager/fs/list?path=${encodeURIComponent(path)}`, { headers: getTokenHeaders() })
                        const data = await res.json()
                        if (res.ok) {
                            fileItems.value = data.items
                            currentPath.value = data.current_path
                            parentPath.value = data.parent_path
                        } else {
                            fileError.value = data.detail || 'Access Denied'
                        }
                    } catch (err) {
                        fileError.value = 'Failed to fetch directory'
                    }
                }

                const downloadFile = (path) => {
                    const token = localStorage.getItem('access_token')
                    // Since download uses standard browser behaviour, we can use window.open but need token
                    // For a proper secure app we should fetch Blob and trigger download link
                    fetch(`/api/manager/fs/download?path=${encodeURIComponent(path)}`, { headers: getTokenHeaders() })
                        .then(res => res.blob())
                        .then(blob => {
                            const url = window.URL.createObjectURL(blob)
                            const a = document.createElement('a')
                            a.href = url
                            a.download = path.split('\\').pop().split('/').pop()
                            document.body.appendChild(a)
                            a.click()
                            window.URL.revokeObjectURL(url)
                            document.body.removeChild(a)
                        })
                }

                const deleteFile = async (path, isDir) => {
                    if (!confirm(`Ë≠¶ÂëäÔºöÊ≠§Êìç‰Ωú‰∏çÂèØÈÄÜÔºåÁ°ÆÂÆöË¶Å‰ªéÁ°¨Áõò‰∏äÂº∫Âà∂Êì¶Èô§ËØ•${isDir ? 'ÁõÆÂΩïÂèäÂÜÖÈÉ®ÊâÄÊúâÊñá‰ª∂' : 'Êñá‰ª∂'}ÂêóÔºü\n\n${path}`)) return
                    try {
                        const res = await fetch(`/api/manager/fs/action`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...getTokenHeaders() },
                            body: JSON.stringify({ action: 'delete', src: path })
                        })
                        if (res.ok) {
                            fetchFiles(currentPath.value)
                        } else {
                            const data = await res.json()
                            alert(data.detail || 'Âà†Èô§ÊâßË°åÂ§±Ë¥•„ÄÇ')
                        }
                    } catch (err) {
                        alert('Âà†Èô§ËØ∑Ê±ÇÂèëÈÄÅÂ§±Ë¥•„ÄÇ')
                    }
                }

                const handleFileUpload = async (event) => {
                    const file = event.target.files[0]
                    if (!file) return

                    const formData = new FormData()
                    formData.append('file', file)

                    try {
                        const res = await fetch(`/api/manager/fs/upload?path=${encodeURIComponent(currentPath.value)}`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` },
                            body: formData
                        })
                        if (res.ok) {
                            alert(`Êñá‰ª∂ ${file.name} Â∑≤ÊàêÂäü‰º†ÈÄÅËá≥ÁõÆÊ†áÁõÆÂΩïÔºÅ`)
                            fetchFiles(currentPath.value)
                        } else {
                            const data = await res.json()
                            alert(data.detail || '‰∏ä‰º†ËØ∑Ê±ÇË¢´ÊãíÁªù')
                        }
                    } catch (err) {
                        alert('‰∏ä‰º†ÊâßË°åÂ§±Ë¥•ÔºåÂèØËÉΩÊòØÊñá‰ª∂Ë∂ÖÈôêÊàñÁΩëÁªúÂºÇÂ∏∏„ÄÇ')
                    } finally {
                        if (fileUploadInput.value) fileUploadInput.value.value = ''
                    }
                }

                const startAutoRefresh = () => {
                    fetchMetricsHistory()
                    fetchRealtimeNetwork()
                    fetchRealtimeSystem()
                    fetchNginxStatus()
                    fetchProcesses()
                    fetchDocker()

                    intervalId = setInterval(() => {
                        fetchMetricsHistory()
                        fetchRealtimeNetwork()
                        fetchRealtimeSystem()
                        fetchNginxStatus()
                    }, 3000)

                    // Processes and Docker don't need to refresh every 3 seconds strictly
                    setInterval(() => {
                        if (isAuthenticated.value) {
                            fetchProcesses()
                            fetchDocker()
                            if (!collapsed.value.syslogs) {
                                fetchLogs()
                            }
                        }
                    }, 10000)
                }

                const stopAutoRefresh = () => {
                    if (intervalId) clearInterval(intervalId)
                }

                onMounted(async () => {
                    await checkToken()
                    if (isAuthenticated.value) {
                        Vue.nextTick(() => {
                            initCharts()
                            fetchNginxConfig()
                            fetchFiles(currentPath.value)
                            loadLayout()
                            fetchLogs()
                            startAutoRefresh()
                        })
                    }
                })

                return {
                    isAuthenticated,
                    loginForm,
                    loginError,
                    timeRange,
                    networkInterfaces,
                    networkConnections,
                    nginxStatus,
                    nginxConfig,
                    nginxLogResult,
                    nginxLoading,
                    processes,
                    dockerInfo,
                    currentPath,
                    parentPath,
                    fileItems,
                    fileError,
                    diskInfo,
                    login,
                    logout,
                    fetchMetricsHistory,
                    saveNginxConfig,
                    analyzeNginxLogs,
                    fetchProcesses,
                    killProcess,
                    fetchDocker,
                    fetchFiles,
                    downloadFile,
                    deleteFile,
                    showPwdModal,
                    openPwdModal,
                    pwdForm,
                    pwdMessage,
                    isDefaultPassword,
                    changePassword,
                    customTime,
                    clearHistory,
                    fileUploadInput,
                    handleFileUpload,
                    translateTcpStatus,
                    collapsed,
                    formatBytes,
                    isEditingLayout,
                    toggleEditLayout,
                    systemLogs,
                    logSeverity,
                    logSource,
                    fetchLogs
                }
            }
        }).mount('#app')
    </script>

</body>

</html>